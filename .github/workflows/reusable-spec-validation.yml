name: Spec Validation

on:
  workflow_call:
    inputs:
      specs-directory:
        description: "Directory containing spec files"
        type: string
        default: "specs/"
      require-spec-for-features:
        description: "Require specs for feature branches"
        type: boolean
        default: true
      spec-template-path:
        description: "Path to spec template for validation"
        type: string
        default: ""
      feature-branch-pattern:
        description: "Regex pattern for feature branch names"
        type: string
        default: "^(feature|feat)/"

jobs:
  validate-specs:
    name: Validate Specs
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if feature branch
        id: branch-check
        run: |
          BRANCH="${{ github.head_ref || github.ref_name }}"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

          if echo "$BRANCH" | grep -qE '${{ inputs.feature-branch-pattern }}'; then
            echo "is_feature=true" >> $GITHUB_OUTPUT
            echo "This is a feature branch: $BRANCH"
          else
            echo "is_feature=false" >> $GITHUB_OUTPUT
            echo "Not a feature branch: $BRANCH"
          fi

      - name: Find related spec directory
        id: find-spec
        run: |
          BRANCH="${{ steps.branch-check.outputs.branch }}"
          SPECS_DIR="${{ inputs.specs-directory }}"

          # Extract feature name from branch (e.g., feature/user-auth -> user-auth)
          FEATURE_NAME=$(echo "$BRANCH" | sed -E 's/^(feature|feat)\///' | sed 's/\//-/g')

          echo "Looking for spec related to: $FEATURE_NAME"

          # Search for spec directory matching feature name
          SPEC_DIR=""
          if [ -d "$SPECS_DIR" ]; then
            # Look for directory matching feature name (with or without 's' suffix)
            SPEC_DIR=$(find "$SPECS_DIR" -type d -name "*${FEATURE_NAME}*" 2>/dev/null | head -1)
          fi

          if [ -n "$SPEC_DIR" ] && [ -d "$SPEC_DIR" ]; then
            echo "Found spec directory: $SPEC_DIR"
            echo "spec_found=true" >> $GITHUB_OUTPUT
            echo "spec_dir=$SPEC_DIR" >> $GITHUB_OUTPUT

            # Check for individual spec files
            [ -f "$SPEC_DIR/requirements.md" ] && echo "has_requirements=true" >> $GITHUB_OUTPUT || echo "has_requirements=false" >> $GITHUB_OUTPUT
            [ -f "$SPEC_DIR/design.md" ] && echo "has_design=true" >> $GITHUB_OUTPUT || echo "has_design=false" >> $GITHUB_OUTPUT
            [ -f "$SPEC_DIR/tasks.md" ] && echo "has_tasks=true" >> $GITHUB_OUTPUT || echo "has_tasks=false" >> $GITHUB_OUTPUT
          else
            echo "No spec directory found for feature: $FEATURE_NAME"
            echo "spec_found=false" >> $GITHUB_OUTPUT
            echo "spec_dir=" >> $GITHUB_OUTPUT
          fi

      - name: Validate spec files
        if: steps.find-spec.outputs.spec_found == 'true'
        id: validate-spec
        run: |
          SPEC_DIR="${{ steps.find-spec.outputs.spec_dir }}"
          ERRORS=""
          WARNINGS=""

          echo "Validating specs in: $SPEC_DIR"

          # Validate requirements.md
          if [ -f "$SPEC_DIR/requirements.md" ]; then
            echo "Validating requirements.md..."
            REQUIRED_SECTIONS=("Goal" "User Stories" "Success Criteria" "Technical Constraints" "Out of Scope")
            for section in "${REQUIRED_SECTIONS[@]}"; do
              if ! grep -qi "^##.*$section" "$SPEC_DIR/requirements.md"; then
                ERRORS="$ERRORS\n- requirements.md: Missing section: $section"
              fi
            done

            # Check for success criteria checkboxes
            if ! grep -qE '^\s*-\s*\[[ x]\]' "$SPEC_DIR/requirements.md"; then
              WARNINGS="$WARNINGS\n- requirements.md: Success criteria should use checkboxes"
            fi

            # Recommended sections
            for section in "Dependencies" "Risks"; do
              if ! grep -qi "^##.*$section" "$SPEC_DIR/requirements.md"; then
                WARNINGS="$WARNINGS\n- requirements.md: Consider adding section: $section"
              fi
            done
          else
            ERRORS="$ERRORS\n- Missing required file: requirements.md"
          fi

          # Validate design.md (if exists)
          if [ -f "$SPEC_DIR/design.md" ]; then
            echo "Validating design.md..."
            DESIGN_SECTIONS=("Overview" "Architecture" "Component Design")
            for section in "${DESIGN_SECTIONS[@]}"; do
              if ! grep -qi "^##.*$section" "$SPEC_DIR/design.md"; then
                WARNINGS="$WARNINGS\n- design.md: Consider adding section: $section"
              fi
            done
          fi

          # Validate tasks.md (if exists)
          if [ -f "$SPEC_DIR/tasks.md" ]; then
            echo "Validating tasks.md..."
            TASKS_SECTIONS=("Progress" "Phase")
            for section in "${TASKS_SECTIONS[@]}"; do
              if ! grep -qi "^##.*$section" "$SPEC_DIR/tasks.md"; then
                WARNINGS="$WARNINGS\n- tasks.md: Consider adding section: $section"
              fi
            done

            # Check for task checkboxes
            if ! grep -qE '^\s*-\s*\[[ x]\]' "$SPEC_DIR/tasks.md"; then
              WARNINGS="$WARNINGS\n- tasks.md: Tasks should use checkboxes"
            fi
          fi

          if [ -n "$ERRORS" ]; then
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "errors<<EOF" >> $GITHUB_OUTPUT
            echo -e "$ERRORS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "errors=" >> $GITHUB_OUTPUT
          fi

          echo "warnings<<EOF" >> $GITHUB_OUTPUT
          echo -e "$WARNINGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post validation results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const isFeature = '${{ steps.branch-check.outputs.is_feature }}' === 'true';
            const specFound = '${{ steps.find-spec.outputs.spec_found }}' === 'true';
            const specDir = '${{ steps.find-spec.outputs.spec_dir }}';
            const hasRequirements = '${{ steps.find-spec.outputs.has_requirements }}' === 'true';
            const hasDesign = '${{ steps.find-spec.outputs.has_design }}' === 'true';
            const hasTasks = '${{ steps.find-spec.outputs.has_tasks }}' === 'true';
            const specValid = '${{ steps.validate-spec.outputs.valid }}' === 'true';
            const errors = `${{ steps.validate-spec.outputs.errors }}`;
            const warnings = `${{ steps.validate-spec.outputs.warnings }}`;
            const requireSpec = '${{ inputs.require-spec-for-features }}' === 'true';

            let body = '## üìã Spec Validation\n\n';

            if (!isFeature) {
              body += '‚úÖ Not a feature branch - spec not required.\n';
            } else if (specFound) {
              body += `‚úÖ Found spec directory: \`${specDir}\`\n\n`;
              body += '**Files found:**\n';
              body += `- requirements.md: ${hasRequirements ? '‚úÖ' : '‚ùå'}\n`;
              body += `- design.md: ${hasDesign ? '‚úÖ' : '‚ö†Ô∏è (optional)'}\n`;
              body += `- tasks.md: ${hasTasks ? '‚úÖ' : '‚ö†Ô∏è (optional)'}\n\n`;

              if (specValid) {
                body += '‚úÖ Spec format is valid.\n';
              } else {
                body += '‚ùå Spec format issues:\n' + errors + '\n';
              }

              if (warnings && warnings.trim()) {
                body += '\n‚ö†Ô∏è Suggestions:\n' + warnings + '\n';
              }
            } else {
              if (requireSpec) {
                body += '‚ùå No spec directory found for this feature branch.\n\n';
                body += 'Please create a spec directory in `${{ inputs.specs-directory }}{feature-name}/` with at least `requirements.md`.\n';
              } else {
                body += '‚ö†Ô∏è No spec directory found for this feature branch.\n\n';
                body += 'Consider creating a spec directory in `${{ inputs.specs-directory }}{feature-name}/`.\n';
              }
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Fail if spec required but missing
        if: |
          inputs.require-spec-for-features &&
          steps.branch-check.outputs.is_feature == 'true' &&
          steps.find-spec.outputs.spec_found == 'false'
        run: |
          echo "::error::Feature branch requires a spec file"
          exit 1

      - name: Fail if spec invalid
        if: |
          steps.find-spec.outputs.spec_found == 'true' &&
          steps.validate-spec.outputs.valid == 'false'
        run: |
          echo "::error::Spec file has format issues"
          exit 1
