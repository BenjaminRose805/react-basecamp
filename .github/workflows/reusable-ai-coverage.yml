name: AI Coverage Analysis

on:
  workflow_call:
    inputs:
      coverage-report-path:
        description: 'Path to coverage report (lcov.info)'
        type: string
        default: 'coverage/lcov.info'
      suggest-tests:
        description: 'Generate test suggestions for uncovered code'
        type: boolean
        default: true
      max-suggestions:
        description: 'Maximum number of test suggestions'
        type: number
        default: 5
      working-directory:
        description: 'Working directory'
        type: string
        default: '.'
      model:
        description: 'Claude model to use'
        type: string
        default: 'claude-sonnet-4-20250514'
    secrets:
      ANTHROPIC_API_KEY:
        description: 'Anthropic API key for Claude'
        required: true

jobs:
  analyze-coverage:
    name: Analyze Test Coverage
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: ${{ inputs.working-directory }}/coverage/
        continue-on-error: true

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Parse coverage report
        id: parse-coverage
        working-directory: ${{ inputs.working-directory }}
        run: |
          COVERAGE_FILE="${{ inputs.coverage-report-path }}"

          if [ ! -f "$COVERAGE_FILE" ]; then
            echo "Coverage file not found: $COVERAGE_FILE"
            echo "has_coverage=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_coverage=true" >> $GITHUB_OUTPUT

          # Parse lcov to find uncovered lines
          UNCOVERED_FILES=""
          CURRENT_FILE=""

          while IFS= read -r line; do
            if [[ $line == SF:* ]]; then
              CURRENT_FILE="${line#SF:}"
            elif [[ $line == DA:* ]]; then
              # DA:line_number,hit_count
              LINE_INFO="${line#DA:}"
              LINE_NUM="${LINE_INFO%,*}"
              HIT_COUNT="${LINE_INFO#*,}"
              if [ "$HIT_COUNT" = "0" ]; then
                UNCOVERED_FILES="$UNCOVERED_FILES\n$CURRENT_FILE:$LINE_NUM"
              fi
            fi
          done < "$COVERAGE_FILE"

          # Get unique files with uncovered lines (top files)
          UNCOVERED_SUMMARY=$(echo -e "$UNCOVERED_FILES" | grep -v '^$' | cut -d: -f1 | sort | uniq -c | sort -rn | head -10)

          echo "uncovered_summary<<EOF" >> $GITHUB_OUTPUT
          echo "$UNCOVERED_SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Get detailed uncovered lines for top 5 files
          TOP_FILES=$(echo -e "$UNCOVERED_FILES" | grep -v '^$' | cut -d: -f1 | sort | uniq -c | sort -rn | head -5 | awk '{print $2}')

          DETAILS=""
          for file in $TOP_FILES; do
            LINES=$(echo -e "$UNCOVERED_FILES" | grep "^$file:" | cut -d: -f2 | head -20 | tr '\n' ',')
            DETAILS="$DETAILS\n$file: lines $LINES"
          done

          echo "uncovered_details<<EOF" >> $GITHUB_OUTPUT
          echo -e "$DETAILS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get changed files in PR
        id: changed-files
        if: github.event_name == 'pull_request'
        run: |
          BASE=${{ github.event.pull_request.base.sha }}
          HEAD=${{ github.event.pull_request.head.sha }}

          CHANGED=$(git diff --name-only $BASE $HEAD | grep -E '\.(ts|tsx|js|jsx)$' | grep -v '\.test\.' | grep -v '\.spec\.' | head -10)

          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate test suggestions
        id: suggestions
        if: inputs.suggest-tests && steps.parse-coverage.outputs.has_coverage == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        working-directory: ${{ inputs.working-directory }}
        run: |
          UNCOVERED="${{ steps.parse-coverage.outputs.uncovered_details }}"
          CHANGED="${{ steps.changed-files.outputs.files }}"

          # Read source code for uncovered files
          SOURCE_SNIPPETS=""
          for file in $(echo -e "$UNCOVERED" | grep -v '^$' | cut -d: -f1 | head -3); do
            if [ -f "$file" ]; then
              SOURCE_SNIPPETS="$SOURCE_SNIPPETS\n\n--- $file ---\n$(head -100 "$file")"
            fi
          done

          PROMPT="Analyze the test coverage gaps and suggest specific tests to write.

          Files with lowest coverage:
          ${{ steps.parse-coverage.outputs.uncovered_summary }}

          Uncovered lines by file:
          $UNCOVERED

          Changed files in this PR:
          $CHANGED

          Source code snippets:
          $SOURCE_SNIPPETS

          Generate ${{ inputs.max-suggestions }} specific, actionable test suggestions.
          For each suggestion, include:
          1. File to test
          2. What to test (function/component/behavior)
          3. Brief test case description

          Format as a numbered list. Focus on the most impactful tests."

          SUGGESTIONS=$(echo "$PROMPT" | claude --print --model ${{ inputs.model }} 2>&1 | head -c 2000 || echo "Unable to generate suggestions")

          echo "suggestions<<EOF" >> $GITHUB_OUTPUT
          echo "$SUGGESTIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post coverage analysis
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const hasCoverage = '${{ steps.parse-coverage.outputs.has_coverage }}' === 'true';
            const uncoveredSummary = `${{ steps.parse-coverage.outputs.uncovered_summary }}`;
            const suggestions = `${{ steps.suggestions.outputs.suggestions }}`;

            let body = '## üìä AI Coverage Analysis\n\n';

            if (!hasCoverage) {
              body += '‚ö†Ô∏è No coverage report found. Run tests with coverage enabled.\n';
            } else {
              body += '### Files with Lowest Coverage\n';
              body += '```\n' + uncoveredSummary + '\n```\n\n';

              if (suggestions) {
                body += '### üí° Suggested Tests\n\n';
                body += suggestions + '\n';
              }
            }

            body += '\n---\n*ü§ñ Analysis by Claude*';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
