name: AI PR Description

on:
  workflow_call:
    inputs:
      include-test-plan:
        description: "Include test plan in description"
        type: boolean
        default: true
      link-to-specs:
        description: "Link to related spec files"
        type: boolean
        default: true
      max-length:
        description: "Maximum length of generated description"
        type: number
        default: 1000
      specs-directory:
        description: "Directory containing spec files"
        type: string
        default: "specs/"
      model:
        description: "Claude model to use (sonnet, opus, or full model name)"
        type: string
        default: "sonnet"
    secrets:
      ANTHROPIC_API_KEY:
        description: "Anthropic API key for Claude"
        required: true

jobs:
  generate-description:
    name: Generate PR Description
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install Claude Code CLI
        run: pnpm add -g @anthropic-ai/claude-code

      - name: Get PR information
        id: pr-info
        run: |
          BASE=${{ github.event.pull_request.base.sha }}
          HEAD=${{ github.event.pull_request.head.sha }}

          # Get commit messages
          COMMITS=$(git log --oneline $BASE..$HEAD | head -20)
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Get changed files summary
          CHANGED=$(git diff --stat $BASE $HEAD | tail -1)
          echo "changes_summary=$CHANGED" >> $GITHUB_OUTPUT

          # Get file list
          FILES=$(git diff --name-only $BASE $HEAD | head -30)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Find related spec
        id: find-spec
        if: inputs.link-to-specs
        run: |
          BRANCH="${{ github.head_ref }}"
          SPECS_DIR="${{ inputs.specs-directory }}"

          FEATURE_NAME=$(echo "$BRANCH" | sed -E 's/^(feature|feat)\///' | sed 's/\//-/g')

          SPEC_FILE=""
          if [ -d "$SPECS_DIR" ]; then
            SPEC_FILE=$(find "$SPECS_DIR" -name "*.md" -type f | xargs grep -l -i "$FEATURE_NAME" 2>/dev/null | head -1)
          fi

          echo "spec_file=$SPEC_FILE" >> $GITHUB_OUTPUT

      - name: Generate description
        id: generate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          COMMITS="${{ steps.pr-info.outputs.commits }}"
          FILES="${{ steps.pr-info.outputs.files }}"
          CHANGES="${{ steps.pr-info.outputs.changes_summary }}"
          SPEC_FILE="${{ steps.find-spec.outputs.spec_file }}"

          # Read spec content if available
          SPEC_CONTENT=""
          if [ -n "$SPEC_FILE" ] && [ -f "$SPEC_FILE" ]; then
            SPEC_CONTENT=$(cat "$SPEC_FILE" | head -c 2000)
          fi

          # Build prompt
          PROMPT="Generate a concise PR description (max ${{ inputs.max-length }} chars) for this pull request.

          Branch: ${{ github.head_ref }}
          Target: ${{ github.base_ref }}

          Commits:
          $COMMITS

          Changed files:
          $FILES

          Changes summary: $CHANGES

          ${SPEC_CONTENT:+Related spec:\n$SPEC_CONTENT}

          Format the description with:
          ## Summary
          - Brief bullet points of what changed

          ${{ inputs.include-test-plan && '## Test Plan\n- How to test these changes' || '' }}

          Keep it concise and focused on the 'what' and 'why'."

          # Generate with Claude
          set +e
          DESCRIPTION=$(echo "$PROMPT" | claude --print --model ${{ inputs.model }} 2>&1)
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ]; then
            echo "::warning::Claude description generation failed with exit code $EXIT_CODE"
            DESCRIPTION="‚ö†Ô∏è AI description could not be generated. Please write manually."
          fi

          # Truncate if needed
          DESCRIPTION=$(echo "$DESCRIPTION" | head -c ${{ inputs.max-length }})

          echo "description<<EOF" >> $GITHUB_OUTPUT
          echo "$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update PR description
        uses: actions/github-script@v7
        with:
          script: |
            const description = `${{ steps.generate.outputs.description }}`;
            const specFile = '${{ steps.find-spec.outputs.spec_file }}';
            const currentBody = context.payload.pull_request.body || '';

            // Only update if current body is empty or has placeholder
            if (currentBody.trim() === '' || currentBody.includes('<!-- AI_GENERATED -->')) {
              let newBody = '<!-- AI_GENERATED -->\n' + description;

              if (specFile) {
                newBody += `\n\n---\nüìã **Spec:** [${specFile}](${specFile})`;
              }

              newBody += '\n\n---\n*ü§ñ Description generated by Claude*';

              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                body: newBody
              });

              console.log('PR description updated');
            } else {
              // Add as comment instead
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ü§ñ AI-Generated Summary\n\n${description}\n\n---\n*Generated by Claude*`
              });

              console.log('Added description as comment (existing body preserved)');
            }
