name: AI Changelog

on:
  workflow_call:
    inputs:
      version:
        description: "Version for the release"
        type: string
        required: true
      include-specs:
        description: "Include links to related specs"
        type: boolean
        default: true
      group-by-type:
        description: "Group changes by type (feat, fix, etc.)"
        type: boolean
        default: true
      create-release:
        description: "Create GitHub release with changelog"
        type: boolean
        default: false
      specs-directory:
        description: "Directory containing spec files"
        type: string
        default: "specs/"
      model:
        description: "Claude model to use (sonnet, opus, or full model name)"
        type: string
        default: "sonnet"
    secrets:
      ANTHROPIC_API_KEY:
        description: "Anthropic API key for Claude"
        required: true

jobs:
  generate-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install Claude Code CLI
        run: pnpm add -g @anthropic-ai/claude-code

      - name: Get commits since last tag
        id: commits
        run: |
          # Find the last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -n "$LAST_TAG" ]; then
            echo "Last tag: $LAST_TAG"
            COMMITS=$(git log ${LAST_TAG}..HEAD --oneline --no-merges)
            FULL_LOG=$(git log ${LAST_TAG}..HEAD --format="- %s (%h)" --no-merges)
          else
            echo "No previous tag found, using all commits"
            COMMITS=$(git log --oneline --no-merges -50)
            FULL_LOG=$(git log --format="- %s (%h)" --no-merges -50)
          fi

          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT

          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "full_log<<EOF" >> $GITHUB_OUTPUT
          echo "$FULL_LOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Find related specs
        id: specs
        if: inputs.include-specs
        run: |
          SPECS_DIR="${{ inputs.specs-directory }}"
          SPECS_LIST=""

          if [ -d "$SPECS_DIR" ]; then
            # Get all spec files
            for spec in $(find "$SPECS_DIR" -name "*.md" -type f); do
              # Get the title from each spec
              TITLE=$(head -5 "$spec" | grep "^#" | head -1 | sed 's/^#\+\s*//')
              if [ -n "$TITLE" ]; then
                SPECS_LIST="$SPECS_LIST\n- [$TITLE]($spec)"
              fi
            done
          fi

          echo "specs_list<<EOF" >> $GITHUB_OUTPUT
          echo -e "$SPECS_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate changelog with AI
        id: changelog
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          COMMITS="${{ steps.commits.outputs.commits }}"
          LAST_TAG="${{ steps.commits.outputs.last_tag }}"
          VERSION="${{ inputs.version }}"
          SPECS="${{ steps.specs.outputs.specs_list }}"

          PROMPT="Generate a changelog for version $VERSION.

          Previous version: ${LAST_TAG:-'(initial release)'}

          Commits since last release:
          $COMMITS

          ${{ inputs.group-by-type && 'Group changes by type using these categories:
          - üöÄ Features (feat:)
          - üêõ Bug Fixes (fix:)
          - üìö Documentation (docs:)
          - üîß Maintenance (chore:, refactor:, ci:)
          - ‚ö†Ô∏è Breaking Changes (BREAKING CHANGE or !)

          ' || '' }}

          Format the changelog in markdown with:
          1. Version header with date
          2. Brief summary (1-2 sentences)
          3. Grouped changes with descriptions
          4. Highlight any breaking changes prominently

          Make the descriptions user-friendly and focus on impact, not implementation details."

          set +e
          CHANGELOG=$(echo "$PROMPT" | claude --print --model ${{ inputs.model }} 2>&1 | head -c 4000)
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ]; then
            echo "::warning::Claude changelog generation failed with exit code $EXIT_CODE"
            CHANGELOG="‚ö†Ô∏è AI changelog could not be generated. Please write manually."
          fi

          # Add specs section if available
          if [ -n "$SPECS" ] && [ "${{ inputs.include-specs }}" = "true" ]; then
            CHANGELOG="$CHANGELOG

          ## üìã Related Specs
          $SPECS"
          fi

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update CHANGELOG.md
        run: |
          CHANGELOG="${{ steps.changelog.outputs.changelog }}"
          VERSION="${{ inputs.version }}"

          # Create or update CHANGELOG.md
          if [ -f "CHANGELOG.md" ]; then
            # Insert new version at the top (after header)
            {
              head -2 CHANGELOG.md
              echo ""
              echo "$CHANGELOG"
              echo ""
              tail -n +3 CHANGELOG.md
            } > CHANGELOG.tmp
            mv CHANGELOG.tmp CHANGELOG.md
          else
            {
              echo "# Changelog"
              echo ""
              echo "$CHANGELOG"
            } > CHANGELOG.md
          fi

          echo "Updated CHANGELOG.md with version $VERSION"

      - name: Commit changelog
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add CHANGELOG.md
          git commit -m "docs: update changelog for ${{ inputs.version }}" || echo "No changes to commit"
          git push || echo "Nothing to push"

      - name: Create GitHub Release
        if: inputs.create-release
        uses: actions/github-script@v7
        with:
          script: |
            const changelog = `${{ steps.changelog.outputs.changelog }}`;
            const version = '${{ inputs.version }}';
            const tagName = version.startsWith('v') ? version : `v${version}`;

            // Create tag if it doesn't exist
            try {
              await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${tagName}`
              });
              console.log(`Tag ${tagName} already exists`);
            } catch (e) {
              // Create the tag
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${tagName}`,
                sha: context.sha
              });
              console.log(`Created tag ${tagName}`);
            }

            // Create release
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tagName,
              name: `Release ${version}`,
              body: changelog,
              draft: false,
              prerelease: version.includes('-')
            });

            console.log(`Created release: ${release.data.html_url}`);

      - name: Output changelog
        run: |
          echo "## Generated Changelog" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.changelog.outputs.changelog }}" >> $GITHUB_STEP_SUMMARY
