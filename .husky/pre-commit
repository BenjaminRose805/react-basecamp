#!/bin/sh

# Pre-commit hook: Runs quality checks on staged files

# Exit on error
set -e

echo "Running pre-commit checks..."

# 1. Run lint-staged (ESLint + Prettier on staged files)
echo "  Running lint-staged..."
npx lint-staged

# 2. Check if package.json was modified - run package existence check
if git diff --cached --name-only | grep -q "package.json"; then
  echo "  Running package existence check (package.json modified)..."
  pnpm run quality:packages
fi

# 3. Run dead UI check on staged tsx/jsx files
STAGED_TSX=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(tsx|jsx)$' || true)
if [ -n "$STAGED_TSX" ]; then
  echo "  Running dead UI check..."
  pnpm run quality:dead-ui
fi

# 4. Run secrets scan on staged files (if gitleaks is installed)
if command -v gitleaks >/dev/null 2>&1; then
  echo "  Running secrets scan..."
  gitleaks protect --staged --no-banner
else
  echo "  Skipping secrets scan (gitleaks not installed)"
fi

echo "Pre-commit checks passed!"
